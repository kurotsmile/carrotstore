var container,stats,canvas,context,baseImage,texture,headTrackerCanvas,video,videoWidth,videoHeight,offsetLeft,offsetTop,maxRatio;var camera,scene,renderer,particles,geometry,materials=[],parameters,i,h,color,projector;var mouseX=0,mouseY=0;var useVideoCanvas=false;var windowHalfX=window.innerWidth/2;var windowHalfY=window.innerHeight/2;var particleCount=50000;loadImage();var modal=document.querySelector(".info");var openModal=document.querySelector(".open-info");openModal.onclick=function(){modal.className="info text"};function loadImage(){baseImage=new Image;baseImage.src="images/screen-test.png";baseImage.onload=function(){prepareCanvas();init();animate()}}function prepareCanvas(){canvas=document.createElement("canvas");var a=document.createElement("canvas");context=canvas.getContext("2d");video=document.querySelector("video");canvas.width=window.innerWidth;canvas.height=window.innerHeight;context.drawImage(baseImage,0,0,canvas.width,canvas.height);headTrackerCanvas=document.createElement("canvas");navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var c={video:true};if(!navigator.getUserMedia){var b=document.querySelector(".get-started");b.className="get-started error";b.innerHTML="Oh no! Your browser doesn't support WebRTC, perhaps try chrome ;)";return}navigator.getUserMedia(c,function(f){document.removeEventListener("mousemove",onDocumentMouseMove,false);document.removeEventListener("touchstart",onDocumentTouchStart,false);document.removeEventListener("touchmove",onDocumentTouchMove,false);window.URL=window.URL||window.webkitURL||window.msURL||window.mozURL;if(window.opera){window.URL=window.URL||{};if(!window.URL.createObjectURL){window.URL.createObjectURL=function(j){return j}}}if(video.mozCaptureStream){video.mozSrcObject=f}else{video.src=(window.URL&&window.URL.createObjectURL(f))||f}var e=function(){videoWidth=video.videoWidth;videoHeight=video.videoHeight;headTrackerCanvas.width=videoWidth/2;headTrackerCanvas.height=videoHeight/2;var k=canvas.width/videoWidth;var j=canvas.height/videoHeight;maxRatio=Math.max(k,j);offsetTop=-((videoHeight*maxRatio)-canvas.height)/2;offsetLeft=-((videoWidth*maxRatio)-canvas.width)/2;useVideoCanvas=true;document.addEventListener("facetrackingEvent",function(l){mouseX=(l.x/headTrackerCanvas.width)*canvas.width-windowHalfX})};var d=function(){setTimeout(e,1000);video.removeEventListener("playing",d,false)};video.addEventListener("playing",d,false);modal.className="info text hidden";var g=new headtrackr.Tracker({ui:false,headPosition:false,detectionInterval:40});g.init(video,headTrackerCanvas);g.start()},function(){console.log("no webgl!")})}function init(){container=document.createElement("div");document.body.appendChild(container);camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,3000);camera.position.z=1600;scene=new THREE.Scene();geometry=new THREE.Geometry();attributes={size:{type:"f",value:[]},customColor:{type:"c",value:[]}};texture=new THREE.Texture(canvas);texture.needsUpdate=true;uniforms={width:{type:"f",value:window.innerWidth*window.devicePixelRatio},height:{type:"f",value:window.innerHeight*window.devicePixelRatio},amplitude:{type:"f",value:1},color:{type:"c",value:new THREE.Color(16777215)},texture:{type:"t",value:texture},};for(i=0;i<particleCount;i++){var e=new THREE.Vector3();e.x=Math.random()*3000-1500;e.y=Math.random()*3000-1500;e.z=Math.random()*3000-1500;geometry.vertices.push(e)}parameters=[[[1,1,0.5],5],[[0.95,1,0.5],4],[[0.9,1,0.5],3],[[0.85,1,0.5],2],[[0.8,1,0.5],1]];for(i=0;i<parameters.length;i++){color=parameters[i][0];size=parameters[i][1];materials[i]=new THREE.ShaderMaterial({uniforms:uniforms,attributes:attributes,vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,blending:THREE.NormalBlending,depthTest:true,transparent:true,size:size});particles=new THREE.ParticleSystem(geometry,materials[i]);particles.dynamic=true;particles.rotation.x=Math.random()*6;particles.rotation.y=Math.random()*6;particles.rotation.z=Math.random()*6;scene.add(particles);var d=particles.geometry.vertices;var a=attributes.size.value;var b=attributes.customColor.value;for(var c=0;c<d.length;c++){a[c]=70+Math.random()*50}}renderer=new THREE.WebGLRenderer();renderer.setSize(window.innerWidth,window.innerHeight);container.appendChild(renderer.domElement);container.onclick=function(){modal.className="info text hidden"};document.addEventListener("mousemove",onDocumentMouseMove,false);document.addEventListener("touchstart",onDocumentTouchStart,false);document.addEventListener("touchmove",onDocumentTouchMove,false);window.addEventListener("resize",onWindowResize,false)}function onWindowResize(){windowHalfX=window.innerWidth/2;windowHalfY=window.innerHeight/2;camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)}function onDocumentMouseMove(a){mouseX=a.clientX-windowHalfX;mouseY=a.clientY-windowHalfY}function onDocumentTouchStart(a){if(a.touches.length===1){a.preventDefault();mouseX=a.touches[0].pageX-windowHalfX;mouseY=a.touches[0].pageY-windowHalfY}}function onDocumentTouchMove(a){if(a.touches.length===1){a.preventDefault();mouseX=a.touches[0].pageX-windowHalfX;mouseY=a.touches[0].pageY-windowHalfY}}function animate(){requestAnimationFrame(animate);render()}function render(){if(useVideoCanvas){context.drawImage(video,offsetLeft,offsetTop,videoWidth*maxRatio,videoHeight*maxRatio)}var b=Date.now()*0.00005;texture.needsUpdate=true;camera.position.x+=(mouseX-camera.position.x)*0.05;camera.position.y+=(-mouseY-camera.position.y)*0.05;camera.lookAt(scene.position);for(i=0;i<scene.children.length;i++){var a=scene.children[i];if(a instanceof THREE.ParticleSystem){a.rotation.x=b*(i<5?i+1:-(i+1))*-0.8}}renderer.render(scene,camera)};