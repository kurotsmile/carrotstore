(function(b){if(typeof define==="function"&&define.amd){define(["jquery"],b)}else{if(typeof module==="object"&&module.exports){module.exports=function(a,d){if(d===undefined){if(typeof window!=="undefined"){d=require("jquery")}else{d=require("jquery")(a)}}b(d);return d}}else{b(jQuery)}}}(function(d){var c={$el:null,commentsById:{},currentSortKey:"",options:{profilePictureURL:"",spinnerIconURL:"",upvoteIconURL:"",replyIconURL:"",noCommentsIconURL:"",textareaPlaceholderText:"Add a comment",popularText:"Popular",newestText:"Newest",oldestText:"Oldest",sendText:"Send",replyText:"Reply",editText:"Edit",editedText:"Edited",youText:"You",saveText:"Save",deleteText:"Delete",viewAllRepliesText:"View all __replyCount__ replies",hideRepliesText:"Hide replies",noCommentsText:"No comments",textFormatter:function(a){return a},enableReplying:true,enableEditing:true,enableUpvoting:true,enableDeleting:true,enableDeletingCommentWithReplies:true,enableNavigation:true,defaultNavigationSortKey:"newest",highlightColor:"#337AB7",deleteButtonColor:"#C9302C",roundProfilePictures:false,textareaRows:2,textareaRowsOnFocus:2,textareaMaxRows:5,maxRepliesVisible:2,fieldMappings:{id:"id",parent:"parent",created:"created",modified:"modified",content:"content",fullname:"fullname",profilePictureURL:"profile_picture_url",createdByAdmin:"created_by_admin",createdByCurrentUser:"created_by_current_user",upvoteCount:"upvote_count",userHasUpvoted:"user_has_upvoted"},getComments:function(a,b){a([])},postComment:function(a,b,f){b(a)},putComment:function(a,b,f){b(a)},deleteComment:function(a,b,f){b()},upvoteComment:function(a,b,f){b(a)},refresh:function(){},timeFormatter:function(a){return new Date(a).toLocaleDateString()}},events:{"keydown [contenteditable]":"saveOnKeydown","focus [contenteditable]":"saveEditableContent","keyup [contenteditable]":"checkEditableContentForChange","paste [contenteditable]":"checkEditableContentForChange","input [contenteditable]":"checkEditableContentForChange","blur [contenteditable]":"checkEditableContentForChange","click .navigation li":"navigationElementClicked","click .commenting-field.main .textarea":"showMainCommentingField","click .commenting-field.main .close":"hideMainCommentingField","click .commenting-field .textarea":"increaseTextareaHeight","change .commenting-field .textarea":"increaseTextareaHeight textareaContentChanged","click .commenting-field:not(.main) .close":"removeCommentingField","click .commenting-field .send.enabled":"postComment","click .commenting-field .update.enabled":"putComment","click .commenting-field .delete.enabled":"deleteComment","click li.comment ul.child-comments .toggle-all":"toggleReplies","click li.comment button.reply":"replyButtonClicked","click li.comment button.edit":"editButtonClicked","click li.comment button.upvote":"upvoteComment"},init:function(b,a){this.$el=d(a);this.$el.addClass("jquery-comments");this.undelegateEvents();this.delegateEvents();(function(f){(jQuery.browser=jQuery.browser||{}).mobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(f)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(f.substr(0,4))})(navigator.userAgent||navigator.vendor||window.opera);if(d.browser.mobile){this.$el.addClass("mobile")}if(b.fieldMappings){b=d.extend({},b);d.extend(this.options.fieldMappings,b.fieldMappings);delete b.fieldMappings}d.extend(this.options,b);this.currentSortKey=this.options.defaultNavigationSortKey;this.createCssDeclarations();this.fetchDataAndRender()},delegateEvents:function(){this.bindEvents(false)},undelegateEvents:function(){this.bindEvents(true)},bindEvents:function(l){var b=l?"off":"on";for(var m in this.events){var o=m.split(" ")[0];var p=m.split(" ").slice(1).join(" ");var k=this.events[m].split(" ");for(var n in k){if(k.hasOwnProperty(n)){var a=this[k[n]];a=d.proxy(a,this);if(p==""){this.$el[b](o,a)}else{this.$el[b](o,p,a)}}}}},fetchDataAndRender:function(){var f=this;this.$el.empty();this.createHTML();this.commentsById={};var a=function(h){var e=h.map(function(g){return f.createCommentModel(g)});f.sortComments(e,"oldest");d(e).each(function(g,j){f.addCommentToDataModel(j)});f.render()};var b=function(){a([])};this.options.getComments(a,b)},createCommentModel:function(a){var b=this.applyInternalMappings(a);b.childs=[];return b},addCommentToDataModel:function(b){if(!(b.id in this.commentsById)){this.commentsById[b.id]=b;if(b.parent){var a=this.getOutermostParent(b.parent);a.childs.push(b.id)}}},updateCommentModel:function(a){d.extend(this.commentsById[a.id],a)},render:function(){var h=this;this.$el.find("#comment-list").remove();var g=d("<ul/>",{id:"comment-list"});var a=[];var b=[];d(this.getComments()).each(function(e,f){if(f.parent==null){a.push(f)}else{b.push(f)}});this.sortComments(a,this.currentSortKey);a.reverse();d(a).each(function(e,f){h.addComment(f,g)});this.sortComments(b,"oldest");d(b).each(function(e,f){h.addComment(f,g)});this.$el.find("> .spinner").remove();this.$el.find(".no-comments").before(g);this.options.refresh()},addComment:function(k,j){j=j||this.$el.find("#comment-list");var a=this.createCommentElement(k);if(k.parent){var b=j.find('.comment[data-id="'+k.parent+'"]');var l=b.parents(".comment").last();if(l.length==0){l=b}var i=l.find(".child-comments");i.append(a);this.updateToggleAllButton(l)}else{j.prepend(a)}},removeComment:function(k){var n=this;var m=this.commentsById[k];var p=this.getChildComments(m.id);d(p).each(function(f,e){n.removeComment(e.id)});if(m.parent){var l=this.getOutermostParent(m.parent);var o=l.childs.indexOf(m.id);l.childs.splice(o,1)}delete this.commentsById[k];var a=this.$el.find('li.comment[data-id="'+k+'"]');var b=a.parents("li.comment").last();a.remove();this.updateToggleAllButton(b)},updateToggleAllButton:function(k){var j=k.find(".child-comments");var n=j.find(".comment");var l=j.find("li.toggle-all");n.removeClass("hidden-reply");var a=n.slice(0,-this.options.maxRepliesVisible);a.addClass("hidden-reply");if(l.find("span.text").text()==this.options.textFormatter(this.options.hideRepliesText)){a.addClass("visible")}if(n.length>this.options.maxRepliesVisible){if(!l.length){l=d("<li/>",{"class":"toggle-all highlight-font-bold"});var m=d("<span/>",{"class":"text"});var b=d("<span/>",{"class":"caret"});l.append(m).append(b);j.prepend(l)}this.setToggleAllButtonText(l,false)}else{l.remove()}},sortComments:function(a,b){var f=this;if(b=="popularity"){a.sort(function(m,n){var o=m.childs.length;var p=n.childs.length;if(f.options.enableUpvoting){o+=m.upvoteCount;p+=n.upvoteCount}if(p!=o){return p-o}else{var e=new Date(m.created).getTime();var l=new Date(n.created).getTime();return l-e}})}else{a.sort(function(k,l){var e=new Date(k.created).getTime();var j=new Date(l.created).getTime();if(b=="newest"){return j-e}else{return e-j}})}},sortAndReArrangeComments:function(f){var b=this.$el.find("#comment-list");var a=this.getComments().filter(function(e){return !e.parent});this.sortComments(a,f);d(a).each(function(i,j){var e=b.find("> li.comment[data-id="+j.id+"]");b.append(e)})},saveOnKeydown:function(a){if(a.keyCode==13&&(a.metaKey||a.ctrlKey)){var b=d(a.currentTarget);b.siblings(".control-row").find(".save").trigger("click");a.stopPropagation();a.preventDefault()}},saveEditableContent:function(a){var b=d(a.currentTarget);b.data("before",b.html())},checkEditableContentForChange:function(a){var b=d(a.currentTarget);if(b.data("before")!=b.html()){b.data("before",b.html());b.trigger("change")}},navigationElementClicked:function(a){var b=d(a.currentTarget);b.siblings().removeClass("active");b.addClass("active");var f=b.data().sortKey;this.sortAndReArrangeComments(f);this.currentSortKey=f},showMainCommentingField:function(a){var b=d(a.currentTarget);b.siblings(".control-row").show();b.parent().find(".close").show();b.focus()},hideMainCommentingField:function(b){var h=d(b.currentTarget);var g=this.$el.find(".commenting-field.main .textarea");var a=this.$el.find(".commenting-field.main .control-row");this.clearTextarea(g);this.adjustTextareaHeight(g,false);a.hide();h.hide();g.blur()},increaseTextareaHeight:function(a){var b=d(a.currentTarget);this.adjustTextareaHeight(b,true)},textareaContentChanged:function(r){var p=d(r.currentTarget);var s=this.getTextareaContent(p);var u=p.siblings(".control-row").find(".save");if(!p.find(".reply-to-badge").length){var t=p.attr("data-comment");if(t){var b=p.parents("li.comment");if(b.length>1){var v=b.last().data("id");p.attr("data-parent",v)}}else{var v=p.parents("li.comment").last().data("id");p.attr("data-parent",v)}}var a=p.parents(".commenting-field").first();if(p[0].scrollHeight>p.outerHeight()){a.addClass("scrollable")}else{a.removeClass("scrollable")}var x=true;if(t=p.attr("data-comment")){var q=s!=this.commentsById[t].content;var w;if(this.commentsById[t].parent){w=this.commentsById[t].parent.toString()}var o=p.attr("data-parent")!=w;x=q||o}if(s.length&&x){u.addClass("enabled")}else{u.removeClass("enabled")}},removeCommentingField:function(a){var g=d(a.currentTarget);var h=g.siblings(".textarea");if(h.attr("data-comment")){g.parents("li.comment").first().removeClass("edit")}var b=g.parents(".commenting-field").first();b.remove()},postComment:function(o){var a=this;var l=d(o.currentTarget);var b=l.parents(".commenting-field").first();var n=b.find(".textarea");l.removeClass("enabled");var r=new Date().toISOString();var q={id:"c"+(this.getComments().length+1),parent:n.attr("data-parent")||null,created:r,modified:r,content:this.getTextareaContent(n),fullname:this.options.textFormatter(this.options.youText),profilePictureURL:this.options.profilePictureURL,createdByCurrentUser:true,upvoteCount:0,userHasUpvoted:false};q=this.applyExternalMappings(q);var m=function(e){var f=a.createCommentModel(e);a.addCommentToDataModel(f);a.addComment(f);b.find(".close").trigger("click")};var p=function(){l.addClass("enabled")};this.options.postComment(q,m,p)},putComment:function(l){var o=this;var k=d(l.currentTarget);var m=k.parents(".commenting-field").first();var p=m.find(".textarea");k.removeClass("enabled");var a=d.extend({},this.commentsById[p.attr("data-comment")]);d.extend(a,{parent:p.attr("data-parent")||null,content:this.getTextareaContent(p),modified:new Date().getTime()});a=this.applyExternalMappings(a);var b=function(e){var f=o.createCommentModel(e);delete f.childs;o.updateCommentModel(f);m.find(".close").trigger("click");o.reRenderComment(f.id)};var n=function(){k.addClass("enabled")};this.options.putComment(a,b,n)},deleteComment:function(l){var o=this;var a=d(l.currentTarget);var p=a.parents(".commenting-field").first().find(".textarea");var b=d.extend({},this.commentsById[p.attr("data-comment")]);var m=b.id;a.removeClass("enabled");b=this.applyExternalMappings(b);var k=function(){o.removeComment(m)};var n=function(){a.addClass("enabled")};this.options.deleteComment(b,k,n)},toggleReplies:function(a){var b=d(a.currentTarget);b.siblings(".hidden-reply").toggleClass("visible");this.setToggleAllButtonText(b,true)},replyButtonClicked:function(b){var j=d(b.currentTarget);var l=j.parents("li.comment").last();var a=j.parents(".comment").first().data().id;var k=l.find(".child-comments > .commenting-field");if(k.length){k.remove()}var m=k.find(".textarea").attr("data-parent");if(m!=a){k=this.createCommentingFieldElement(a);l.find(".child-comments").append(k);var n=k.find(".textarea");this.moveCursorToEnd(n)}},editButtonClicked:function(i){var b=d(i.currentTarget);var a=b.parents("li.comment").first();var j=a.data().model;a.addClass("edit");var k=this.createCommentingFieldElement(j.parent,j.id);a.find(".comment-wrapper").first().append(k);var l=k.find(".textarea");l.attr("data-comment",j.id);l.append(this.getTextareaContentAsEscapedHTML(j.content));this.moveCursorToEnd(l)},upvoteComment:function(m){var a=this;var p=d(m.currentTarget).parents("li.comment").first();var b=p.data().model;var r=b.upvoteCount;var o;if(b.userHasUpvoted){o=r-1}else{o=r+1}b.userHasUpvoted=!b.userHasUpvoted;b.upvoteCount=o;this.reRenderUpvotes(b.id);var q=d.extend({},b);q=this.applyExternalMappings(q);var l=function(e){var f=a.createCommentModel(e);a.updateCommentModel(f);a.reRenderUpvotes(f.id)};var n=function(){b.userHasUpvoted=!b.userHasUpvoted;b.upvoteCount=r;a.reRenderUpvotes(b.id)};this.options.upvoteComment(q,l,n)},createHTML:function(){var n=this;var l=this.createCommentingFieldElement();l.addClass("main");this.$el.append(l);var b=l.find(".control-row");b.hide();l.find(".close").hide();if(this.options.enableNavigation){this.$el.append(this.createNavigationElement())}var a=d("<div/>",{"class":"spinner"});var k=d("<i/>",{"class":"fa fa-spinner fa-spin"});if(this.options.spinnerIconURL.length){k.css("background-image",'url("'+this.options.spinnerIconURL+'")');k.addClass("image")}a.html(k);this.$el.append(a);var m=d("<div/>",{"class":"no-comments",text:this.options.textFormatter(this.options.noCommentsText)});var j=d("<i/>",{"class":"fa fa-comments fa-2x"});if(this.options.noCommentsIconURL.length){j.css("background-image",'url("'+this.options.noCommentsIconURL+'")');j.addClass("image")}m.prepend(d("<br/>")).prepend(j);this.$el.append(m)},createProfilePictureElement:function(a){var b=d("<img/>",{src:a,"class":"profile-picture"+(this.options.roundProfilePictures?" round":"")});return b},createCommentingFieldElement:function(A,E){var H=this;var a=d("<div/>",{"class":"commenting-field"});var w=this.createProfilePictureElement(this.options.profilePictureURL);w.addClass("by-current-user");var z=d("<div/>",{"class":"textarea-wrapper"});var F=d("<div/>",{"class":"control-row"});var b=d("<div/>",{"class":"textarea","data-placeholder":this.options.textFormatter(this.options.textareaPlaceholderText),contenteditable:true});this.adjustTextareaHeight(b,false);var G=d("<span/>",{"class":"close"}).append(d('<span class="left"/>')).append(d('<span class="right"/>'));if(E){var y=this.options.textFormatter(this.options.saveText);if(this.options.enableDeleting){var C=true;if(!this.options.enableDeletingCommentWithReplies){d(this.getComments()).each(function(f,e){if(e.parent==E){C=false}})}if(C){var v=d("<span/>",{"class":"enabled delete",text:this.options.textFormatter(this.options.deleteText)}).css("background-color",this.options.deleteButtonColor);F.append(v)}}}else{var y=this.options.textFormatter(this.options.sendText)}var t=E?"update":"send";var B=d("<span/>",{"class":t+" save highlight-background",text:y});F.prepend(B);z.append(G).append(b).append(F);a.append(w).append(z);if(A){b.attr("data-parent",A);var D=this.commentsById[A];if(D.parent){b.html("&nbsp;");var x=d("<input/>",{"class":"reply-to-badge highlight-font-bold",type:"button"});var u="@"+D.fullname;x.val(u);b.prepend(x)}}return a},createNavigationElement:function(){var b=d("<ul/>",{"class":"navigation"});var h=d("<li/>",{text:this.options.textFormatter(this.options.newestText),"data-sort-key":"newest"});var i=d("<li/>",{text:this.options.textFormatter(this.options.oldestText),"data-sort-key":"oldest"});var a=d("<li/>",{text:this.options.textFormatter(this.options.popularText),"data-sort-key":"popularity"});b.append(h).append(i);var j=this.options.enableReplying||this.options.enableUpvoting;if(j){b.append(a)}b.find("[data-sort-key="+this.currentSortKey+"]").addClass("active");return b},createCommentElement:function(g){var a=d("<li/>",{"data-id":g.id,"class":"comment"}).data("model",g);if(g.createdByCurrentUser){a.addClass("by-current-user")}if(g.createdByAdmin){a.addClass("by-admin")}var h=d("<ul/>",{"class":"child-comments"});var b=this.createCommentWrapperElement(g);a.append(b);if(g.parent==null){a.append(h)}return a},createCommentWrapperElement:function(u){var C=d("<div/>",{"class":"comment-wrapper"});var b=this.createProfilePictureElement(u.profilePictureURL);var G=d("<time/>",{text:this.options.timeFormatter(u.created),"data-original":u.created});var a=d("<div/>",{"class":"name",text:u.fullname});if(u.createdByAdmin){a.addClass("highlight-font-bold")}if(u.parent){var F=this.commentsById[u.parent];if(F.parent){var v=d("<span/>",{"class":"reply-to",text:F.fullname});var B=d("<i/>",{"class":"fa fa-share"});if(this.options.replyIconURL.length){B.css("background-image",'url("'+this.options.replyIconURL+'")');B.addClass("image")}v.prepend(B);a.append(v)}}var H=d("<div/>",{"class":"wrapper"});var w=d("<div/>",{"class":"content",text:u.content}).html(this.linkify(this.escape(u.content)));if(u.modified&&u.modified!=u.created){var E=this.options.timeFormatter(u.modified);var J=d("<time/>",{"class":"edited",text:this.options.textFormatter(this.options.editedText)+" "+E,"data-original":u.modified});w.append(J)}var D=d("<span/>",{"class":"actions"});var I=d("<span/>",{"class":"separator",text:"·"});var A=d("<button/>",{"class":"action reply",text:this.options.textFormatter(this.options.replyText)});var y=d("<i/>",{"class":"fa fa-thumbs-o-up"});if(this.options.upvoteIconURL.length){y.css("background-image",'url("'+this.options.upvoteIconURL+'")');y.addClass("image")}var x=this.createUpvoteElement(u);var z=d("<button/>",{"class":"action edit",text:this.options.textFormatter(this.options.editText)});if(this.options.enableReplying){D.append(A)}if(this.options.enableUpvoting){D.append(x)}if(this.options.enableEditing&&u.createdByCurrentUser){D.append(z)}D.children().each(function(f,e){if(!d(e).is(":last-child")){d(e).after(I.clone())}});H.append(w);H.append(D);C.append(b).append(G).append(a).append(H);return C},createUpvoteElement:function(a){var b=d("<i/>",{"class":"fa fa-thumbs-o-up"});if(this.options.upvoteIconURL.length){b.css("background-image",'url("'+this.options.upvoteIconURL+'")');b.addClass("image")}var f=d("<button/>",{"class":"action upvote"+(a.userHasUpvoted?" highlight-font":"")}).append(d("<span/>",{text:a.upvoteCount,"class":"upvote-count"})).append(b);return f},reRenderComment:function(a){var h=this.commentsById[a];var g=this.createCommentWrapperElement(h);var b=this.$el.find('li.comment[data-id="'+h.id+'"]');b.find("> .comment-wrapper").replaceWith(g)},reRenderUpvotes:function(a){var h=this.commentsById[a];var g=this.createUpvoteElement(h);var b=this.$el.find('li.comment[data-id="'+h.id+'"]');b.find(".upvote").first().replaceWith(g)},createCssDeclarations:function(){d("head style.jquery-comments-css").remove();this.createCss(".jquery-comments ul.navigation li.active:after {background: "+this.options.highlightColor+" !important;",+"}");this.createCss(".jquery-comments .highlight-background {background: "+this.options.highlightColor+" !important;",+"}");this.createCss(".jquery-comments .highlight-font {color: "+this.options.highlightColor+" !important;}");this.createCss(".jquery-comments .highlight-font-bold {color: "+this.options.highlightColor+" !important;font-weight: bold;}")},createCss:function(b){var a=d("<style/>",{type:"text/css","class":"jquery-comments-css",text:b});d("head").append(a)},getComments:function(){var a=this;return Object.keys(this.commentsById).map(function(b){return a.commentsById[b]})},getChildComments:function(a){return this.getComments().filter(function(b){return b.parent==a})},getOutermostParent:function(f){var a=f;do{var b=this.commentsById[a];a=b.parent}while(b.parent!=null);return b},setToggleAllButtonText:function(l,n){var m=this;var b=l.find("span.text");var a=l.find(".caret");var k=function(){var e=m.options.textFormatter(m.options.viewAllRepliesText);var f=l.siblings(".comment").length;e=e.replace("__replyCount__",f);b.text(e)};var j=this.options.textFormatter(this.options.hideRepliesText);if(n){if(b.text()==j){k()}else{b.text(j)}a.toggleClass("up")}else{if(b.text()!=j){k()}}},adjustTextareaHeight:function(n,o){var a=2.2;var l=1.45;var p=function(e){var f=a+(e-1)*l;n.css("height",f+"em")};n=d(n);var m=o==true?this.options.textareaRowsOnFocus:this.options.textareaRows;do{p(m);m++;var k=n[0].scrollHeight>n.outerHeight();var b=this.options.textareaMaxRows==false?false:m>this.options.textareaMaxRows}while(k&&!b)},clearTextarea:function(a){a.empty().trigger("input")},getTextareaContent:function(f){var b=d("<pre/>").html(f.html());b.find("div, p, br").replaceWith(function(){return"\n"+this.innerHTML});var a=b.text().replace(/^\s+/g,"");return a},getTextareaContentAsEscapedHTML:function(b){var a=this.escape(b);return a.replace(/(?:\n)/g,"<br>")},moveCursorToEnd:function(g){g=d(g)[0];d(g).trigger("input");d(g).scrollTop(g.scrollHeight);if(typeof window.getSelection!="undefined"&&typeof document.createRange!="undefined"){var h=document.createRange();h.selectNodeContents(g);h.collapse(false);var a=window.getSelection();a.removeAllRanges();a.addRange(h)}else{if(typeof document.body.createTextRange!="undefined"){var b=document.body.createTextRange();b.moveToElementText(g);b.collapse(false);b.select()}}g.focus()},escape:function(a){return d("<pre/>").text(a).html()},linkify:function(m){var r,b,n,o;b=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;r=m.replace(b,'<a href="$1" target="_blank">$1</a>');n=/(^|[^\/f])(www\.[\S]+(\b|$))/gim;r=r.replace(n,'$1<a href="http://$2" target="_blank">$2</a>');o=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;r=r.replace(o,'<a href="mailto:$1">$1</a>');var a=m.match(/<a href/g)||[];if(a.length>0){var p=m.split(/(<\/a>)/g);for(var i=0;i<p.length;i++){if(p[i].match(/<a href/g)==null){p[i]=p[i].replace(b,'<a href="$1" target="_blank">$1</a>').replace(n,'$1<a href="http://$2" target="_blank">$2</a>').replace(o,'<a href="mailto:$1">$1</a>')}}var q=p.join("");return q}else{return r}},applyInternalMappings:function(g){var h={};var a=this.options.fieldMappings;for(var b in a){if(a.hasOwnProperty(b)){h[a[b]]=b}}return this.applyMappings(h,g)},applyExternalMappings:function(b){var a=this.options.fieldMappings;return this.applyMappings(a,b)},applyMappings:function(a,b){var j={};for(var h in b){if(h in a){var i=a[h];j[i]=b[h]}}return j}};d.fn.comments=function(a){return this.each(function(){var b=Object.create(c);b.init(a||{},this);d.data(this,"comments",b)})}}));