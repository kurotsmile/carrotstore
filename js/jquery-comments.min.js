/*!     jquery-comments.js 1.4.0
 *
 *     (c) 2017 Joona TykkylÃ¤inen, Viima Solutions Oy
 *     jquery-comments may be freely distributed under the MIT license.
 *     For all details and documentation:
 *     http://viima.github.io/jquery-comments/
 */
(function(a){if(typeof define==="function"&&define.amd){define(["jquery"],a)}else{if(typeof module==="object"&&module.exports){module.exports=function(b,c){if(c===undefined){if(typeof window!=="undefined"){c=require("jquery")}else{c=require("jquery")(b)}}a(c);return c}}else{a(jQuery)}}}(function(a){var b={$el:null,commentsById:{},dataFetched:false,currentSortKey:"",options:{},events:{click:"closeDropdowns","keydown [contenteditable]":"saveOnKeydown","focus [contenteditable]":"saveEditableContent","keyup [contenteditable]":"checkEditableContentForChange","paste [contenteditable]":"checkEditableContentForChange","input [contenteditable]":"checkEditableContentForChange","blur [contenteditable]":"checkEditableContentForChange","click .navigation li[data-sort-key]":"navigationElementClicked","click .navigation li.title":"toggleNavigationDropdown","click .commenting-field.main .textarea":"showMainCommentingField","click .commenting-field.main .close":"hideMainCommentingField","click .commenting-field .textarea":"increaseTextareaHeight","change .commenting-field .textarea":"increaseTextareaHeight textareaContentChanged","click .commenting-field:not(.main) .close":"removeCommentingField","click .commenting-field .send.enabled":"postComment","click .commenting-field .update.enabled":"putComment","click .commenting-field .delete.enabled":"deleteComment",'change .commenting-field .upload.enabled input[type="file"]':"fileInputChanged","click li.comment button.upvote":"upvoteComment","click li.comment button.delete.enabled":"deleteComment","click li.comment .hashtag":"hashtagClicked","click li.comment .ping":"pingClicked","click li.comment ul.child-comments .toggle-all":"toggleReplies","click li.comment button.reply":"replyButtonClicked","click li.comment button.edit":"editButtonClicked",dragenter:"showDroppableOverlay","dragenter .droppable-overlay":"handleDragEnter","dragleave .droppable-overlay":"handleDragLeaveForOverlay","dragenter .droppable-overlay .droppable":"handleDragEnter","dragleave .droppable-overlay .droppable":"handleDragLeaveForDroppable","dragover .droppable-overlay":"handleDragOverForOverlay","drop .droppable-overlay":"handleDrop","click .dropdown.autocomplete":"stopPropagation","mousedown .dropdown.autocomplete":"stopPropagation","touchstart .dropdown.autocomplete":"stopPropagation",},getDefaultOptions:function(){return{profilePictureURL:"",currentUserIsAdmin:false,currentUserId:null,spinnerIconURL:"",upvoteIconURL:"",replyIconURL:"",uploadIconURL:"",attachmentIconURL:"",fileIconURL:"",noCommentsIconURL:"",textareaPlaceholderText:"Add a comment",newestText:"Newest",oldestText:"Oldest",popularText:"Popular",attachmentsText:"Attachments",sendText:"Send",replyText:"Reply",editText:"Edit",editedText:"Edited",youText:"You",saveText:"Save",deleteText:"Delete",newText:"New",viewAllRepliesText:"View all __replyCount__ replies",hideRepliesText:"Hide replies",noCommentsText:"No comments",noAttachmentsText:"No attachments",attachmentDropText:"Drop files here",textFormatter:function(c){return c},enableReplying:true,enableEditing:true,enableUpvoting:true,enableDeleting:true,enableAttachments:false,enableHashtags:false,enablePinging:false,enableDeletingCommentWithReplies:false,enableNavigation:true,postCommentOnEnter:false,forceResponsive:false,readOnly:false,defaultNavigationSortKey:"newest",highlightColor:"#2793e6",deleteButtonColor:"#C9302C",scrollContainer:this.$el,roundProfilePictures:false,textareaRows:2,textareaRowsOnFocus:2,textareaMaxRows:5,maxRepliesVisible:2,fieldMappings:{id:"id",parent:"parent",created:"created",modified:"modified",content:"content",file:"file",fileURL:"file_url",fileMimeType:"file_mime_type",pings:"pings",creator:"creator",fullname:"fullname",profileURL:"profile_url",profilePictureURL:"profile_picture_url",isNew:"is_new",createdByAdmin:"created_by_admin",createdByCurrentUser:"created_by_current_user",upvoteCount:"upvote_count",userHasUpvoted:"user_has_upvoted"},searchUsers:function(d,e,c){e([])},getComments:function(d,c){d([])},postComment:function(e,d,c){d(e)},putComment:function(e,d,c){d(e)},deleteComment:function(e,d,c){d()},upvoteComment:function(e,d,c){d(e)},hashtagClicked:function(c){},pingClicked:function(c){},uploadAttachments:function(e,d,c){d(e)},refresh:function(){},timeFormatter:function(c){return new Date(c).toLocaleDateString()}}},init:function(c,d){this.$el=a(d);this.$el.addClass("jquery-comments");this.undelegateEvents();this.delegateEvents();(function(e){(jQuery.browser=jQuery.browser||{}).mobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))})(navigator.userAgent||navigator.vendor||window.opera);if(a.browser.mobile){this.$el.addClass("mobile")}this.options=a.extend(true,{},this.getDefaultOptions(),c);if(this.options.readOnly){this.$el.addClass("read-only")}this.currentSortKey=this.options.defaultNavigationSortKey;this.createCssDeclarations();this.fetchDataAndRender()},delegateEvents:function(){this.bindEvents(false)},undelegateEvents:function(){this.bindEvents(true)},bindEvents:function(g){var i=g?"off":"on";for(var f in this.events){var d=f.split(" ")[0];var c=f.split(" ").slice(1).join(" ");var h=this.events[f].split(" ");for(var e in h){if(h.hasOwnProperty(e)){var j=this[h[e]];j=a.proxy(j,this);if(c==""){this.$el[i](d,j)}else{this.$el[i](d,c,j)}}}}},fetchDataAndRender:function(){var c=this;this.commentsById={};this.$el.empty();this.createHTML();this.options.getComments(function(d){var e=d.map(function(f){return c.createCommentModel(f)});c.sortComments(e,"oldest");a(e).each(function(g,f){c.addCommentToDataModel(f)});c.dataFetched=true;c.render()})},fetchNext:function(){var c=this;var f=this.createSpinner();this.$el.find("ul#comment-list").append(f);var e=function(g){a(g).each(function(i,h){c.createComment(h)});f.remove()};var d=function(){f.remove()};this.options.getComments(e,d)},createCommentModel:function(d){var c=this.applyInternalMappings(d);c.childs=[];return c},addCommentToDataModel:function(c){if(!(c.id in this.commentsById)){this.commentsById[c.id]=c;if(c.parent){var d=this.getOutermostParent(c.parent);d.childs.push(c.id)}}},updateCommentModel:function(c){a.extend(this.commentsById[c.id],c)},render:function(){var c=this;if(!this.dataFetched){return}this.showActiveContainer();this.createComments();if(this.options.enableAttachments){this.createAttachments()}this.$el.find("> .spinner").remove();this.options.refresh()},showActiveContainer:function(){var c=this.$el.find(".navigation li[data-container-name].active");var e=c.data("container-name");var d=this.$el.find('[data-container="'+e+'"]');d.siblings("[data-container]").hide();d.show()},createComments:function(){var c=this;this.$el.find("#comment-list").remove();var d=a("<ul/>",{id:"comment-list","class":"main"});var f=[];var e=[];a(this.getComments()).each(function(h,g){if(g.parent==null){f.push(g)}else{e.push(g)}});this.sortComments(f,this.currentSortKey);f.reverse();a(f).each(function(h,g){c.addComment(g,d)});this.sortComments(e,"oldest");a(e).each(function(h,g){c.addComment(g,d)});this.$el.find('[data-container="comments"]').prepend(d)},createAttachments:function(){var d=this;this.$el.find("#attachment-list").remove();var e=a("<ul/>",{id:"attachment-list","class":"main"});var c=this.getAttachments();this.sortComments(c,"newest");c.reverse();a(c).each(function(g,f){d.addAttachment(f,e)});this.$el.find('[data-container="attachments"]').prepend(e)},addComment:function(d,e){e=e||this.$el.find("#comment-list");var i=this.createCommentElement(d);if(d.parent){var h=e.find('.comment[data-id="'+d.parent+'"]');this.reRenderCommentActionBar(d.parent);var c=h.parents(".comment").last();if(c.length==0){c=h}var g=c.find(".child-comments");var f=g.find(".commenting-field");if(f.length){f.before(i)}else{g.append(i)}this.updateToggleAllButton(c)}else{if(this.currentSortKey=="newest"){e.prepend(i)}else{e.append(i)}}},addAttachment:function(c,d){d=d||this.$el.find("#attachment-list");var e=this.createCommentElement(c);d.prepend(e)},removeComment:function(h){var e=this;var f=this.commentsById[h];var c=this.getChildComments(f.id);a(c).each(function(k,l){e.removeComment(l.id)});if(f.parent){var g=this.getOutermostParent(f.parent);var d=g.childs.indexOf(f.id);g.childs.splice(d,1)}delete this.commentsById[h];var j=this.$el.find('li.comment[data-id="'+h+'"]');var i=j.parents("li.comment").last();j.remove();this.updateToggleAllButton(i)},uploadAttachments:function(d,l){var n=this;if(!l){l=this.$el.find(".commenting-field.main")}var m=l.find(".upload");var e=!l.hasClass("main");var f=d.length;if(f){var j=l.find(".textarea");m.removeClass("enabled");var g=this.createSpinner();var h=this.createSpinner();this.$el.find("ul#attachment-list").prepend(g);if(e){l.before(h)}else{this.$el.find("ul#comment-list").prepend(h)}var k=function(o){a(o).each(function(q,r){var p=n.createCommentModel(r);n.addCommentToDataModel(p);n.addComment(p);n.addAttachment(p)});if(o.length==f&&n.getTextareaContent(j).length==0){l.find(".close").trigger("click")}m.addClass("enabled");h.remove();g.remove()};var i=function(){m.addClass("enabled");h.remove();g.remove()};var c=[];a(d).each(function(o,p){var q=n.createCommentJSON(j);q.id+="-"+o;q.content="";q.file=p;q.fileURL="C:/fakepath/"+p.name;q.fileMimeType=p.type;q=n.applyExternalMappings(q);c.push(q)});n.options.uploadAttachments(c,k,i)}m.find("input").val("")},updateToggleAllButton:function(f){if(this.options.maxRepliesVisible==null){return}var g=f.find(".child-comments");var c=g.find(".comment").not(".hidden");var e=g.find("li.toggle-all");c.removeClass("togglable-reply");if(this.options.maxRepliesVisible===0){var i=c}else{var i=c.slice(0,-this.options.maxRepliesVisible)}i.addClass("togglable-reply");if(e.find("span.text").text()==this.options.textFormatter(this.options.hideRepliesText)){i.addClass("visible")}if(c.length>this.options.maxRepliesVisible){if(!e.length){e=a("<li/>",{"class":"toggle-all highlight-font-bold"});var d=a("<span/>",{"class":"text"});var h=a("<span/>",{"class":"caret"});e.append(d).append(h);g.prepend(e)}this.setToggleAllButtonText(e,false)}else{e.remove()}},updateToggleAllButtons:function(){var c=this;var d=this.$el.find("#comment-list");d.find(".comment").removeClass("visible");d.children(".comment").each(function(e,f){c.updateToggleAllButton(a(f))})},sortComments:function(e,d){var c=this;if(d=="popularity"){e.sort(function(i,h){var g=i.childs.length;var f=h.childs.length;if(c.options.enableUpvoting){g+=i.upvoteCount;f+=h.upvoteCount}if(f!=g){return f-g}else{var k=new Date(i.created).getTime();var j=new Date(h.created).getTime();return j-k}})}else{e.sort(function(g,f){var i=new Date(g.created).getTime();var h=new Date(f.created).getTime();if(d=="oldest"){return i-h}else{return h-i}})}},sortAndReArrangeComments:function(c){var d=this.$el.find("#comment-list");var e=this.getComments().filter(function(f){return !f.parent});this.sortComments(e,c);a(e).each(function(g,f){var h=d.find("> li.comment[data-id="+f.id+"]");d.append(h)})},showActiveSort:function(){var d=this.$el.find('.navigation li[data-sort-key="'+this.currentSortKey+'"]');this.$el.find(".navigation li").removeClass("active");d.addClass("active");var c=this.$el.find(".navigation .title");if(this.currentSortKey!="attachments"){c.addClass("active");c.find("header").html(d.first().html())}else{var e=this.$el.find(".navigation ul.dropdown").children().first();c.find("header").html(e.html())}this.showActiveContainer()},forceResponsive:function(){this.$el.addClass("responsive")},closeDropdowns:function(){this.$el.find(".dropdown").hide()},saveOnKeydown:function(d){if(d.keyCode==13){var e=d.metaKey||d.ctrlKey;if(this.options.postCommentOnEnter||e){var c=a(d.currentTarget);c.siblings(".control-row").find(".save").trigger("click");d.stopPropagation();d.preventDefault()}}},saveEditableContent:function(d){var c=a(d.currentTarget);c.data("before",c.html())},checkEditableContentForChange:function(d){var c=a(d.currentTarget);a(c[0].childNodes).each(function(){if(this.nodeType==Node.TEXT_NODE&&this.length==0&&this.removeNode){this.removeNode()}});if(c.data("before")!=c.html()){c.data("before",c.html());c.trigger("change")}},navigationElementClicked:function(e){var d=a(e.currentTarget);var c=d.data().sortKey;if(c!="attachments"){this.sortAndReArrangeComments(c)}this.currentSortKey=c;this.showActiveSort()},toggleNavigationDropdown:function(c){c.stopPropagation();var d=a(c.currentTarget).find("~ .dropdown");d.toggle()},showMainCommentingField:function(d){var c=a(d.currentTarget);c.siblings(".control-row").show();c.parent().find(".close").show();c.parent().find(".upload.inline-button").hide();c.focus()},hideMainCommentingField:function(e){var c=a(e.currentTarget);var d=this.$el.find(".commenting-field.main .textarea");var f=this.$el.find(".commenting-field.main .control-row");this.clearTextarea(d);this.adjustTextareaHeight(d,false);f.hide();c.hide();d.parent().find(".upload.inline-button").show();d.blur()},increaseTextareaHeight:function(d){var c=a(d.currentTarget);this.adjustTextareaHeight(c,true)},textareaContentChanged:function(i){var k=a(i.currentTarget);var f=k.siblings(".control-row").find(".save");if(!k.find(".reply-to.tag").length){var g=k.attr("data-comment");if(g){var m=k.parents("li.comment");if(m.length>1){var e=m.last().data("id");k.attr("data-parent",e)}}else{var e=k.parents("li.comment").last().data("id");k.attr("data-parent",e)}}var n=k.parents(".commenting-field").first();if(k[0].scrollHeight>k.outerHeight()){n.addClass("commenting-field-scrollable")}else{n.removeClass("commenting-field-scrollable")}var c=true;var h=this.getTextareaContent(k,true);if(commentModel=this.commentsById[k.attr("data-comment")]){var j=h!=commentModel.content;var d;if(commentModel.parent){d=commentModel.parent.toString()}var l=k.attr("data-parent")!=d;c=j||l}if(h.length&&c){f.addClass("enabled")}else{f.removeClass("enabled")}},removeCommentingField:function(f){var d=a(f.currentTarget);var c=d.siblings(".textarea");if(c.attr("data-comment")){d.parents("li.comment").first().removeClass("edit")}var e=d.parents(".commenting-field").first();e.remove()},postComment:function(h){var d=this;var f=a(h.currentTarget);var g=f.parents(".commenting-field").first();var c=g.find(".textarea");f.removeClass("enabled");var j=this.createCommentJSON(c);j=this.applyExternalMappings(j);var i=function(k){d.createComment(k);g.find(".close").trigger("click")};var e=function(){f.addClass("enabled")};this.options.postComment(j,i,e)},createComment:function(d){var c=this.createCommentModel(d);this.addCommentToDataModel(c);this.addComment(c)},putComment:function(g){var d=this;var h=a(g.currentTarget);var f=h.parents(".commenting-field").first();var c=f.find(".textarea");h.removeClass("enabled");var j=a.extend({},this.commentsById[c.attr("data-comment")]);a.extend(j,{parent:c.attr("data-parent")||null,content:this.getTextareaContent(c),pings:this.getPings(c),modified:new Date().getTime()});j=this.applyExternalMappings(j);var i=function(l){var k=d.createCommentModel(l);delete k.childs;d.updateCommentModel(k);f.find(".close").trigger("click");d.reRenderComment(k.id)};var e=function(){h.addClass("enabled")};this.options.putComment(j,i,e)},deleteComment:function(i){var k=this;var h=a(i.currentTarget);var f=h.parents(".comment").first();var d=a.extend({},this.commentsById[f.attr("data-id")]);var e=d.id;var c=d.parent;h.removeClass("enabled");d=this.applyExternalMappings(d);var j=function(){k.removeComment(e);if(c){k.reRenderCommentActionBar(c)}};var g=function(){h.addClass("enabled")};this.options.deleteComment(d,j,g)},hashtagClicked:function(d){var c=a(d.currentTarget);var e=c.attr("data-value");this.options.hashtagClicked(e)},pingClicked:function(d){var c=a(d.currentTarget);var e=c.attr("data-value");this.options.pingClicked(e)},fileInputChanged:function(e,d){var d=e.currentTarget.files;var c=a(e.currentTarget).parents(".commenting-field").first();this.uploadAttachments(d,c)},upvoteComment:function(h){var k=this;var e=a(h.currentTarget).parents("li.comment").first();var j=e.data().model;var c=j.upvoteCount;var f;if(j.userHasUpvoted){f=c-1}else{f=c+1}j.userHasUpvoted=!j.userHasUpvoted;j.upvoteCount=f;this.reRenderUpvotes(j.id);var d=a.extend({},j);d=this.applyExternalMappings(d);var i=function(m){var l=k.createCommentModel(m);k.updateCommentModel(l);k.reRenderUpvotes(l.id)};var g=function(){j.userHasUpvoted=!j.userHasUpvoted;j.upvoteCount=c;k.reRenderUpvotes(j.id)};this.options.upvoteComment(d,i,g)},toggleReplies:function(d){var c=a(d.currentTarget);c.siblings(".togglable-reply").toggleClass("visible");this.setToggleAllButtonText(c,true)},replyButtonClicked:function(k){var m=a(k.currentTarget);var c=m.parents("li.comment").last();var h=m.parents(".comment").first().data().id;var j=c.find(".child-comments > .commenting-field");if(j.length){j.remove()}var i=j.find(".textarea").attr("data-parent");if(i!=h){j=this.createCommentingFieldElement(h);c.find(".child-comments").append(j);var l=j.find(".textarea");this.moveCursorToEnd(l);var e=this.options.scrollContainer.scrollTop();var g=e+j.position().top+j.outerHeight();var f=e+this.options.scrollContainer.outerHeight();if(g>f){var d=e+(g-f);this.options.scrollContainer.scrollTop(d)}}},editButtonClicked:function(f){var g=a(f.currentTarget);var h=g.parents("li.comment").first();var e=h.data().model;h.addClass("edit");var d=this.createCommentingFieldElement(e.parent,e.id);h.find(".comment-wrapper").first().append(d);var c=d.find(".textarea");c.attr("data-comment",e.id);c.append(this.getFormattedCommentContent(e,true));this.moveCursorToEnd(c)},showDroppableOverlay:function(c){if(this.options.enableAttachments){this.$el.find(".droppable-overlay").css("top",this.$el[0].scrollTop);this.$el.find(".droppable-overlay").show();this.$el.addClass("drag-ongoing")}},handleDragEnter:function(d){var c=a(d.currentTarget).data("dnd-count")||0;c++;a(d.currentTarget).data("dnd-count",c);a(d.currentTarget).addClass("drag-over")},handleDragLeave:function(d,e){var c=a(d.currentTarget).data("dnd-count");c--;a(d.currentTarget).data("dnd-count",c);if(c==0){a(d.currentTarget).removeClass("drag-over");if(e){e()}}},handleDragLeaveForOverlay:function(d){var c=this;this.handleDragLeave(d,function(){c.hideDroppableOverlay()})},handleDragLeaveForDroppable:function(c){this.handleDragLeave(c)},handleDragOverForOverlay:function(c){c.stopPropagation();c.preventDefault();c.originalEvent.dataTransfer.dropEffect="copy"},hideDroppableOverlay:function(){this.$el.find(".droppable-overlay").hide();this.$el.removeClass("drag-ongoing")},handleDrop:function(c){c.preventDefault();a(c.target).trigger("dragleave");this.hideDroppableOverlay();this.uploadAttachments(c.originalEvent.dataTransfer.files)},stopPropagation:function(c){c.stopPropagation()},createHTML:function(){var q=this;var h=this.createMainCommentingFieldElement();this.$el.append(h);var k=h.find(".control-row");k.hide();h.find(".close").hide();if(this.options.enableNavigation){this.$el.append(this.createNavigationElement());this.showActiveSort()}var o=this.createSpinner();this.$el.append(o);var d=a("<div/>",{"class":"data-container","data-container":"comments"});this.$el.append(d);var l=a("<div/>",{"class":"no-comments no-data",text:this.options.textFormatter(this.options.noCommentsText)});var p=a("<i/>",{"class":"fa fa-comments fa-2x"});if(this.options.noCommentsIconURL.length){p.css("background-image",'url("'+this.options.noCommentsIconURL+'")');p.addClass("image")}l.prepend(a("<br/>")).prepend(p);d.append(l);if(this.options.enableAttachments){var f=a("<div/>",{"class":"data-container","data-container":"attachments"});this.$el.append(f);var n=a("<div/>",{"class":"no-attachments no-data",text:this.options.textFormatter(this.options.noAttachmentsText)});var c=a("<i/>",{"class":"fa fa-paperclip fa-2x"});if(this.options.attachmentIconURL.length){c.css("background-image",'url("'+this.options.attachmentIconURL+'")');c.addClass("image")}n.prepend(a("<br/>")).prepend(c);f.append(n);var m=a("<div/>",{"class":"droppable-overlay"});var e=a("<div/>",{"class":"droppable-container"});var j=a("<div/>",{"class":"droppable"});var g=a("<i/>",{"class":"fa fa-paperclip fa-4x"});if(this.options.uploadIconURL.length){g.css("background-image",'url("'+this.options.uploadIconURL+'")');g.addClass("image")}var i=a("<div/>",{text:this.options.textFormatter(this.options.attachmentDropText)});j.append(g);j.append(i);m.html(e.html(j)).hide();this.$el.append(m)}},createProfilePictureElement:function(e,c){if(e){var d=a("<div/>").css({"background-image":"url("+e+")"})}else{var d=a("<i/>",{"class":"fa fa-user"})}d.addClass("profile-picture");d.attr("data-user-id",c);if(this.options.roundProfilePictures){d.addClass("round")}return d},createMainCommentingFieldElement:function(){return this.createCommentingFieldElement(undefined,undefined,true)},createCommentingFieldElement:function(v,n,o){var t=this;var u=a("<div/>",{"class":"commenting-field"});if(o){u.addClass("main")}if(n){var r=this.commentsById[n].profilePictureURL;var k=this.commentsById[n].creator}else{var r=this.options.profilePictureURL;var k=this.options.creator}var x=this.createProfilePictureElement(r,k);var w=a("<div/>",{"class":"textarea-wrapper"});var q=a("<div/>",{"class":"control-row"});var s=a("<div/>",{"class":"textarea","data-placeholder":this.options.textFormatter(this.options.textareaPlaceholderText),contenteditable:true});this.adjustTextareaHeight(s,false);var h=a("<span/>",{"class":"close inline-button"}).append(a('<span class="left"/>')).append(a('<span class="right"/>'));if(n){var d=this.options.textFormatter(this.options.saveText);var m=a("<span/>",{"class":"delete",text:this.options.textFormatter(this.options.deleteText)}).css("background-color",this.options.deleteButtonColor);q.append(m);if(this.isAllowedToDelete(n)){m.addClass("enabled")}}else{var d=this.options.textFormatter(this.options.sendText);if(this.options.enableAttachments){var g=a("<span/>",{"class":"enabled upload"});var j=a("<i/>",{"class":"fa fa-paperclip"});var i=a("<input/>",{type:"file","data-role":"none"});if(!a.browser.mobile){i.attr("multiple","multiple")}if(this.options.uploadIconURL.length){j.css("background-image",'url("'+this.options.uploadIconURL+'")');j.addClass("image")}g.append(j).append(i);q.append(g.clone());if(o){w.append(g.clone().addClass("inline-button"))}}}var p=n?"update":"send";var f=a("<span/>",{"class":p+" save highlight-background",text:d});q.prepend(f);w.append(h).append(s).append(q);u.append(x).append(w);if(v){s.attr("data-parent",v);var c=this.commentsById[v];if(c.parent){s.html("&nbsp;");var e="@"+c.fullname;var l=this.createTagElement(e,"reply-to",c.creator,{"data-user-id":c.creator});s.prepend(l)}}if(this.options.enablePinging){s.textcomplete([{match:/(^|\s)@([^@]*)$/i,index:2,search:function(z,A){z=t.normalizeSpaces(z);var y=function(){A([])};t.options.searchUsers(z,A,y)},template:function(A){var D=a("<div/>");var y=t.createProfilePictureElement(A.profile_picture_url);var z=a("<div/>",{"class":"details",});var B=a("<div/>",{"class":"name",}).html(A.fullname);var C=a("<div/>",{"class":"email",}).html(A.email);if(A.email){z.append(B).append(C)}else{z.addClass("no-email");z.append(B)}D.append(y).append(z);return D.html()},replace:function(z){var y=t.createTagElement("@"+z.fullname,"ping",z.id,{"data-user-id":z.id});return" "+y[0].outerHTML+" "},}],{appendTo:".jquery-comments",dropdownClassName:"dropdown autocomplete",maxCount:5,rightEdgeOffset:0,debounce:250});a.fn.textcomplete.Dropdown.prototype.render=function(z){var F=this._buildContents(z);var A=a.map(z,function(G){return G.value});if(z.length){var E=z[0].strategy;if(E.id){this.$el.attr("data-strategy",E.id)}else{this.$el.removeAttr("data-strategy")}this._renderHeader(A);this._renderFooter(A);if(F){this._renderContents(F);this._fitToBottom();this._fitToRight();this._activateIndexedItem()}this._setScroll()}else{if(this.noResultsMessage){this._renderNoResultsMessage(A)}else{if(this.shown){this.deactivate()}}}var D=parseInt(this.$el.css("top"))+t.options.scrollContainer.scrollTop();this.$el.css("top",D);var C=this.$el.css("left");this.$el.css("left",0);var y=t.$el.width()-this.$el.outerWidth();var B=Math.min(y,parseInt(C));this.$el.css("left",B)};a.fn.textcomplete.ContentEditable.prototype._skipSearch=function(y){switch(y.keyCode){case 9:case 13:case 16:case 17:case 33:case 34:case 40:case 38:case 27:return true}if(y.ctrlKey){switch(y.keyCode){case 78:case 80:return true}}}}return u},createNavigationElement:function(){var j=a("<ul/>",{"class":"navigation"});var m=a("<div/>",{"class":"navigation-wrapper"});j.append(m);var l=a("<li/>",{text:this.options.textFormatter(this.options.newestText),"data-sort-key":"newest","data-container-name":"comments"});var h=a("<li/>",{text:this.options.textFormatter(this.options.oldestText),"data-sort-key":"oldest","data-container-name":"comments"});var e=a("<li/>",{text:this.options.textFormatter(this.options.popularText),"data-sort-key":"popularity","data-container-name":"comments"});var g=a("<li/>",{text:this.options.textFormatter(this.options.attachmentsText),"data-sort-key":"attachments","data-container-name":"attachments"});var i=a("<i/>",{"class":"fa fa-paperclip"});if(this.options.attachmentIconURL.length){i.css("background-image",'url("'+this.options.attachmentIconURL+'")');i.addClass("image")}g.prepend(i);var d=a("<div/>",{"class":"navigation-wrapper responsive"});var c=a("<ul/>",{"class":"dropdown"});var f=a("<li/>",{"class":"title"});var k=a("<header/>");f.append(k);d.append(f);d.append(c);j.append(d);m.append(l).append(h);c.append(l.clone()).append(h.clone());if(this.options.enableReplying||this.options.enableUpvoting){m.append(e);c.append(e.clone())}if(this.options.enableAttachments){m.append(g);d.append(g.clone())}if(this.options.forceResponsive){this.forceResponsive()}return j},createSpinner:function(){var d=a("<div/>",{"class":"spinner"});var c=a("<i/>",{"class":"fa fa-spinner fa-spin"});if(this.options.spinnerIconURL.length){c.css("background-image",'url("'+this.options.spinnerIconURL+'")');c.addClass("image")}d.html(c);return d},createCommentElement:function(d){var f=a("<li/>",{"data-id":d.id,"class":"comment"}).data("model",d);if(d.createdByCurrentUser){f.addClass("by-current-user")}if(d.createdByAdmin){f.addClass("by-admin")}var c=a("<ul/>",{"class":"child-comments"});var e=this.createCommentWrapperElement(d);f.append(e);if(d.parent==null){f.append(c)}return f},createCommentWrapperElement:function(E){var q=a("<div/>",{"class":"comment-wrapper"});var F=this.createProfilePictureElement(E.profilePictureURL,E.creator);var i=a("<time/>",{text:this.options.timeFormatter(E.created),"data-original":E.created});var I=a("<span/>",{"data-user-id":E.creator,text:E.createdByCurrentUser?this.options.textFormatter(this.options.youText):E.fullname});if(E.profileURL){I=a("<a/>",{href:E.profileURL,html:I})}var v=a("<div/>",{"class":"name",html:I});if(E.createdByAdmin){v.addClass("highlight-font-bold")}if(E.parent){var m=this.commentsById[E.parent];if(m.parent){var D=a("<span/>",{"class":"reply-to",text:m.fullname,"data-user-id":m.creator});var s=a("<i/>",{"class":"fa fa-share"});if(this.options.replyIconURL.length){s.css("background-image",'url("'+this.options.replyIconURL+'")');s.addClass("image")}D.prepend(s);v.append(D)}}if(E.isNew){var C=a("<span/>",{"class":"new highlight-background",text:this.options.textFormatter(this.options.newText)});v.append(C)}var g=a("<div/>",{"class":"wrapper"});var y=a("<div/>",{"class":"content"});var G=E.fileURL!=undefined;if(G){var A=null;var f=null;if(E.fileMimeType){var p=E.fileMimeType.split("/");if(p.length==2){A=p[1];f=p[0]}}var k=a("<a/>",{"class":"attachment",href:E.fileURL,target:"_blank"});if(f=="image"){var t=a("<img/>",{src:E.fileURL});k.html(t)}else{if(f=="video"){var z=a("<video/>",{src:E.fileURL,type:E.fileMimeType,controls:"controls"});k.html(z)}else{var j=["archive","audio","code","excel","image","movie","pdf","photo","picture","powerpoint","sound","video","word","zip"];var c="fa fa-file-o";if(j.indexOf(A)>0){c="fa fa-file-"+A+"-o"}else{if(j.indexOf(f)>0){c="fa fa-file-"+f+"-o"}}var B=a("<i/>",{"class":c});if(this.options.fileIconURL.length){B.css("background-image",'url("'+this.options.fileIconURL+'")');B.addClass("image")}var x=E.fileURL.split("/");var H=x[x.length-1];H=H.split("?")[0];H=decodeURIComponent(H);k.text(H);k.prepend(B)}}y.html(k)}else{y.html(this.getFormattedCommentContent(E))}if(E.modified&&E.modified!=E.created){var o=this.options.timeFormatter(E.modified);var d=a("<time/>",{"class":"edited",text:this.options.textFormatter(this.options.editedText)+" "+o,"data-original":E.modified});y.append(d)}var n=a("<span/>",{"class":"actions"});var e=a("<span/>",{"class":"separator",text:"Â·"});var r=a("<button/>",{"class":"action reply",type:"button",text:this.options.textFormatter(this.options.replyText)});var u=a("<i/>",{"class":"fa fa-thumbs-up"});if(this.options.upvoteIconURL.length){u.css("background-image",'url("'+this.options.upvoteIconURL+'")');u.addClass("image")}var w=this.createUpvoteElement(E);if(this.options.enableReplying){n.append(r)}if(this.options.enableUpvoting){n.append(w)}if(E.createdByCurrentUser||this.options.currentUserIsAdmin){if(G&&this.isAllowedToDelete(E.id)){var h=a("<button/>",{"class":"action delete enabled",text:this.options.textFormatter(this.options.deleteText)});n.append(h)}else{if(!G&&this.options.enableEditing){var l=a("<button/>",{"class":"action edit",text:this.options.textFormatter(this.options.editText)});n.append(l)}}}n.children().each(function(J,K){if(!a(K).is(":last-child")){a(K).after(e.clone())}});g.append(y);g.append(n);q.append(F).append(i).append(v).append(g);return q},createUpvoteElement:function(e){var d=a("<i/>",{"class":"fa fa-thumbs-up"});if(this.options.upvoteIconURL.length){d.css("background-image",'url("'+this.options.upvoteIconURL+'")');d.addClass("image")}var c=a("<button/>",{"class":"action upvote"+(e.userHasUpvoted?" highlight-font":"")}).append(a("<span/>",{text:e.upvoteCount,"class":"upvote-count"})).append(d);return c},createTagElement:function(g,d,f,e){var c=a("<input/>",{"class":"tag",type:"button","data-role":"none",});if(d){c.addClass(d)}c.val(g);c.attr("data-value",f);if(e){c.attr(e)}return c},reRenderComment:function(f){var d=this.commentsById[f];var e=this.$el.find('li.comment[data-id="'+d.id+'"]');var c=this;e.each(function(g,i){var h=c.createCommentWrapperElement(d);a(i).find(".comment-wrapper").first().replaceWith(h)})},reRenderCommentActionBar:function(f){var d=this.commentsById[f];var e=this.$el.find('li.comment[data-id="'+d.id+'"]');var c=this;e.each(function(g,i){var h=c.createCommentWrapperElement(d);a(i).find(".actions").first().replaceWith(h.find(".actions"))})},reRenderUpvotes:function(f){var d=this.commentsById[f];var e=this.$el.find('li.comment[data-id="'+d.id+'"]');var c=this;e.each(function(g,i){var h=c.createUpvoteElement(d);a(i).find(".upvote").first().replaceWith(h)})},createCssDeclarations:function(){a("head style.jquery-comments-css").remove();this.createCss(".jquery-comments ul.navigation li.active:after {background: "+this.options.highlightColor+" !important;",+"}");this.createCss(".jquery-comments ul.navigation ul.dropdown li.active {background: "+this.options.highlightColor+" !important;",+"}");this.createCss(".jquery-comments .highlight-background {background: "+this.options.highlightColor+" !important;",+"}");this.createCss(".jquery-comments .highlight-font {color: "+this.options.highlightColor+" !important;}");this.createCss(".jquery-comments .highlight-font-bold {color: "+this.options.highlightColor+" !important;font-weight: bold;}")},createCss:function(c){var d=a("<style/>",{type:"text/css","class":"jquery-comments-css",text:c});a("head").append(d)},getComments:function(){var c=this;return Object.keys(this.commentsById).map(function(d){return c.commentsById[d]})},getChildComments:function(c){return this.getComments().filter(function(d){return d.parent==c})},getAttachments:function(){return this.getComments().filter(function(c){return c.fileURL!=undefined})},getOutermostParent:function(c){var e=c;do{var d=this.commentsById[e];e=d.parent}while(d.parent!=null);return d},createCommentJSON:function(c){var d=new Date().toISOString();var e={id:"c"+(this.getComments().length+1),parent:c.attr("data-parent")||null,created:d,modified:d,content:this.getTextareaContent(c),pings:this.getPings(c),fullname:this.options.textFormatter(this.options.youText),profilePictureURL:this.options.profilePictureURL,createdByCurrentUser:true,upvoteCount:0,userHasUpvoted:false};return e},isAllowedToDelete:function(d){if(this.options.enableDeleting){var c=true;if(!this.options.enableDeletingCommentWithReplies){a(this.getComments()).each(function(e,f){if(f.parent==d){c=false}})}return c}return false},setToggleAllButtonText:function(e,c){var d=this;var h=e.find("span.text");var i=e.find(".caret");var f=function(){var k=d.options.textFormatter(d.options.viewAllRepliesText);var j=e.siblings(".comment").not(".hidden").length;k=k.replace("__replyCount__",j);h.text(k)};var g=this.options.textFormatter(this.options.hideRepliesText);if(c){if(h.text()==g){f()}else{h.text(g)}i.toggleClass("up")}else{if(h.text()!=g){f()}}},adjustTextareaHeight:function(e,d){var j=2.2;var g=1.45;var c=function(l){var k=j+(l-1)*g;e.css("height",k+"em")};e=a(e);var f=d==true?this.options.textareaRowsOnFocus:this.options.textareaRows;do{c(f);f++;var h=e[0].scrollHeight>e.outerHeight();var i=this.options.textareaMaxRows==false?false:f>this.options.textareaMaxRows}while(h&&!i)},clearTextarea:function(c){c.empty().trigger("input")},getTextareaContent:function(d,c){var e=d.clone();e.find(".reply-to.tag").remove();e.find(".tag.hashtag").replaceWith(function(){return c?a(this).val():"#"+a(this).attr("data-value")});e.find(".tag.ping").replaceWith(function(){return c?a(this).val():"@"+a(this).attr("data-value")});var f=a("<pre/>").html(e.html());f.find("div, p, br").replaceWith(function(){return"\n"+this.innerHTML});var g=f.text().replace(/^\s+/g,"");var g=this.normalizeSpaces(g);return g},getFormattedCommentContent:function(d,c){var e=this.escape(d.content);e=this.linkify(e);e=this.highlightTags(d,e);if(c){e=e.replace(/(?:\n)/g,"<br>")}return e},getPings:function(c){var d={};c.find(".ping").each(function(e,f){var h=parseInt(a(f).attr("data-value"));var g=a(f).val();d[h]=g.slice(1)});return d},moveCursorToEnd:function(d){d=a(d)[0];a(d).trigger("input");a(d).scrollTop(d.scrollHeight);if(typeof window.getSelection!="undefined"&&typeof document.createRange!="undefined"){var c=document.createRange();c.selectNodeContents(d);c.collapse(false);var f=window.getSelection();f.removeAllRanges();f.addRange(c)}else{if(typeof document.body.createTextRange!="undefined"){var e=document.body.createTextRange();e.moveToElementText(d);e.collapse(false);e.select()}}d.focus()},escape:function(c){return a("<pre/>").text(this.normalizeSpaces(c)).html()},normalizeSpaces:function(c){return c.replace(new RegExp("\u00a0","g")," ")},after:function(e,d){var c=this;return function(){e--;if(e==0){return d.apply(c,arguments)}}},highlightTags:function(c,d){if(this.options.enableHashtags){d=this.highlightHashtags(c,d)}if(this.options.enablePinging){d=this.highlightPings(c,d)}return d},highlightHashtags:function(d,e){var c=this;if(e.indexOf("#")!=-1){var f=function(h){var h=c.createTagElement("#"+h,"hashtag",h);return h[0].outerHTML};var g=/(^|\s)#([a-zÃ¤Ã¶Ã¼Ã\d-_]+)/gim;e=e.replace(g,function(i,h,j){return h+f(j)})}return e},highlightPings:function(d,e){var c=this;if(e.indexOf("@")!=-1){var f=function(h,i){var g=c.createTagElement(h,"ping",i,{"data-user-id":i});return g[0].outerHTML};a(Object.keys(d.pings)).each(function(i,j){var h=d.pings[j];var g="@"+h;e=e.replace(new RegExp(g,"g"),f(g,j))})}return e},linkify:function(h){var c,k,g,f;k=/(\b(https?|ftp|file):\/\/[-A-ZÃÃÃ0-9+&@#\/%?=~_|!:,.;]*[-A-ZÃÃÃ0-9+&@#\/%=~_|])/gim;c=h.replace(k,'<a href="$1" target="_blank">$1</a>');g=/(^|[^\/f])(www\.[-A-ZÃÃÃ0-9+&@#\/%?=~_|!:,.;]*[-A-ZÃÃÃ0-9+&@#\/%=~_|])/gim;c=c.replace(g,'$1<a href="https://$2" target="_blank">$2</a>');f=/(([A-ZÃÃÃ0-9\-\_\.])+@[A-ZÃÃÃ\_]+?(\.[A-ZÃÃÃ]{2,6})+)/gim;c=c.replace(f,'<a href="mailto:$1">$1</a>');var l=h.match(/<a href/g)||[];if(l.length>0){var e=h.split(/(<\/a>)/g);for(var j=0;j<e.length;j++){if(e[j].match(/<a href/g)==null){e[j]=e[j].replace(k,'<a href="$1" target="_blank">$1</a>').replace(g,'$1<a href="https://$2" target="_blank">$2</a>').replace(f,'<a href="mailto:$1">$1</a>')}}var d=e.join("");return d}else{return c}},waitUntil:function(e,d){var c=this;if(e()){d()}else{setTimeout(function(){c.waitUntil(e,d)},100)}},applyInternalMappings:function(d){var c={};var f=this.options.fieldMappings;for(var e in f){if(f.hasOwnProperty(e)){c[f[e]]=e}}return this.applyMappings(c,d)},applyExternalMappings:function(c){var d=this.options.fieldMappings;return this.applyMappings(d,c)},applyMappings:function(g,f){var c={};for(var e in f){if(e in g){var d=g[e];c[d]=f[e]}}return c}};a.fn.comments=function(c){return this.each(function(){var d=Object.create(b);a.data(this,"comments",d);d.init(c||{},this)})}}));