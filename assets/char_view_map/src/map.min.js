jvm.Map=function(c){var b=this,a;this.params=jvm.$.extend(true,{},jvm.Map.defaultParams,c);if(!jvm.Map.maps[this.params.map]){throw new Error("Attempt to use map which was not loaded: "+this.params.map)}this.mapData=jvm.Map.maps[this.params.map];this.markers={};this.regions={};this.regionsColors={};this.regionsData={};this.container=jvm.$("<div>").addClass("jvectormap-container");if(this.params.container){this.params.container.append(this.container)}this.container.data("mapObject",this);this.defaultWidth=this.mapData.width;this.defaultHeight=this.mapData.height;this.setBackgroundColor(this.params.backgroundColor);this.onResize=function(){b.updateSize()};jvm.$(window).resize(this.onResize);for(a in jvm.Map.apiEvents){if(this.params[a]){this.container.bind(jvm.Map.apiEvents[a]+".jvectormap",this.params[a])}}this.canvas=new jvm.VectorCanvas(this.container[0],this.width,this.height);if(this.params.bindTouchEvents){if(("ontouchstart" in window)||(window.DocumentTouch&&document instanceof DocumentTouch)){this.bindContainerTouchEvents()}else{if(window.MSGesture){this.bindContainerPointerEvents()}}}this.bindContainerEvents();this.bindElementEvents();this.createTip();if(this.params.zoomButtons){this.bindZoomButtons()}this.createRegions();this.createMarkers(this.params.markers||{});this.updateSize();if(this.params.focusOn){if(typeof this.params.focusOn==="string"){this.params.focusOn={region:this.params.focusOn}}else{if(jvm.$.isArray(this.params.focusOn)){this.params.focusOn={regions:this.params.focusOn}}}this.setFocus(this.params.focusOn)}if(this.params.selectedRegions){this.setSelectedRegions(this.params.selectedRegions)}if(this.params.selectedMarkers){this.setSelectedMarkers(this.params.selectedMarkers)}this.legendCntHorizontal=jvm.$("<div/>").addClass("jvectormap-legend-cnt jvectormap-legend-cnt-h");this.legendCntVertical=jvm.$("<div/>").addClass("jvectormap-legend-cnt jvectormap-legend-cnt-v");this.container.append(this.legendCntHorizontal);this.container.append(this.legendCntVertical);if(this.params.series){this.createSeries()}};jvm.Map.prototype={transX:0,transY:0,scale:1,baseTransX:0,baseTransY:0,baseScale:1,width:0,height:0,setBackgroundColor:function(a){this.container.css("background-color",a)},resize:function(){var a=this.baseScale;if(this.width/this.height>this.defaultWidth/this.defaultHeight){this.baseScale=this.height/this.defaultHeight;this.baseTransX=Math.abs(this.width-this.defaultWidth*this.baseScale)/(2*this.baseScale)}else{this.baseScale=this.width/this.defaultWidth;this.baseTransY=Math.abs(this.height-this.defaultHeight*this.baseScale)/(2*this.baseScale)}this.scale*=this.baseScale/a;this.transX*=this.baseScale/a;this.transY*=this.baseScale/a},updateSize:function(){this.width=this.container.width();this.height=this.container.height();this.resize();this.canvas.setSize(this.width,this.height);this.applyTransform()},reset:function(){var b,a;for(b in this.series){for(a=0;a<this.series[b].length;a++){this.series[b][a].clear()}}this.scale=this.baseScale;this.transX=this.baseTransX;this.transY=this.baseTransY;this.applyTransform()},applyTransform:function(){var c,b,a,d;if(this.defaultWidth*this.scale<=this.width){c=(this.width-this.defaultWidth*this.scale)/(2*this.scale);a=(this.width-this.defaultWidth*this.scale)/(2*this.scale)}else{c=0;a=(this.width-this.defaultWidth*this.scale)/this.scale}if(this.defaultHeight*this.scale<=this.height){b=(this.height-this.defaultHeight*this.scale)/(2*this.scale);d=(this.height-this.defaultHeight*this.scale)/(2*this.scale)}else{b=0;d=(this.height-this.defaultHeight*this.scale)/this.scale}if(this.transY>b){this.transY=b}else{if(this.transY<d){this.transY=d}}if(this.transX>c){this.transX=c}else{if(this.transX<a){this.transX=a}}this.canvas.applyTransformParams(this.scale,this.transX,this.transY);if(this.markers){this.repositionMarkers()}this.repositionLabels();this.container.trigger("viewportChange",[this.scale/this.baseScale,this.transX,this.transY])},bindContainerEvents:function(){var b=false,c,a,d=this;if(this.params.panOnDrag){this.container.mousemove(function(f){if(b){d.transX-=(c-f.pageX)/d.scale;d.transY-=(a-f.pageY)/d.scale;d.applyTransform();c=f.pageX;a=f.pageY}return false}).mousedown(function(f){b=true;c=f.pageX;a=f.pageY;return false});this.onContainerMouseUp=function(){b=false};jvm.$("body").mouseup(this.onContainerMouseUp)}if(this.params.zoomOnScroll){this.container.mousewheel(function(h,l,f,e){var k=jvm.$(d.container).offset(),j=h.pageX-k.left,i=h.pageY-k.top,g=Math.pow(1+d.params.zoomOnScrollSpeed/1000,h.deltaFactor*h.deltaY);d.tip.hide();d.setScale(d.scale*g,j,i);h.preventDefault()})}},bindContainerTouchEvents:function(){var b,e,a=this,i,h,d,c,g,f=function(m){var l=m.originalEvent.touches,o,n,k,j;if(m.type=="touchstart"){g=0}if(l.length==1){if(g==1){k=a.transX;j=a.transY;a.transX-=(i-l[0].pageX)/a.scale;a.transY-=(h-l[0].pageY)/a.scale;a.applyTransform();a.tip.hide();if(k!=a.transX||j!=a.transY){m.preventDefault()}}i=l[0].pageX;h=l[0].pageY}else{if(l.length==2){if(g==2){n=Math.sqrt(Math.pow(l[0].pageX-l[1].pageX,2)+Math.pow(l[0].pageY-l[1].pageY,2))/e;a.setScale(b*n,d,c);a.tip.hide();m.preventDefault()}else{o=jvm.$(a.container).offset();if(l[0].pageX>l[1].pageX){d=l[1].pageX+(l[0].pageX-l[1].pageX)/2}else{d=l[0].pageX+(l[1].pageX-l[0].pageX)/2}if(l[0].pageY>l[1].pageY){c=l[1].pageY+(l[0].pageY-l[1].pageY)/2}else{c=l[0].pageY+(l[1].pageY-l[0].pageY)/2}d-=o.left;c-=o.top;b=a.scale;e=Math.sqrt(Math.pow(l[0].pageX-l[1].pageX,2)+Math.pow(l[0].pageY-l[1].pageY,2))}}}g=l.length};jvm.$(this.container).bind("touchstart",f);jvm.$(this.container).bind("touchmove",f)},bindContainerPointerEvents:function(){var e=this,c=new MSGesture(),b=this.container[0],d=function(f){c.addPointer(f.pointerId)},a=function(h){var j,i,g,f;if(h.translationX!=0||h.translationY!=0){g=e.transX;f=e.transY;e.transX+=h.translationX/e.scale;e.transY+=h.translationY/e.scale;e.applyTransform();e.tip.hide();if(g!=e.transX||f!=e.transY){h.preventDefault()}}if(h.scale!=1){e.setScale(e.scale*h.scale,h.offsetX,h.offsetY);e.tip.hide();h.preventDefault()}};c.target=b;b.addEventListener("MSGestureChange",a,false);b.addEventListener("pointerdown",d,false)},bindElementEvents:function(){var d=this,b,a,c;this.container.mousemove(function(f){if(Math.abs(b-f.pageX)+Math.abs(a-f.pageY)>2){c=true}});this.container.delegate("[class~='jvectormap-element']","mouseover mouseout",function(l){var g=jvm.$(this).attr("class").baseVal||jvm.$(this).attr("class"),i=g.indexOf("jvectormap-region")===-1?"marker":"region",j=i=="region"?jvm.$(this).attr("data-code"):jvm.$(this).attr("data-index"),h=i=="region"?d.regions[j].element:d.markers[j].element,f=i=="region"?d.mapData.paths[j].name:(d.markers[j].config.name||""),k=jvm.$.Event(i+"TipShow.jvectormap"),m=jvm.$.Event(i+"Over.jvectormap");if(l.type=="mouseover"){d.container.trigger(m,[j]);if(!m.isDefaultPrevented()){h.setHovered(true)}d.tip.text(f);d.container.trigger(k,[d.tip,j]);if(!k.isDefaultPrevented()){d.tip.show();d.tipWidth=d.tip.width();d.tipHeight=d.tip.height()}}else{h.setHovered(false);d.tip.hide();d.container.trigger(i+"Out.jvectormap",[j])}});this.container.delegate("[class~='jvectormap-element']","mousedown",function(f){b=f.pageX;a=f.pageY;c=false});this.container.delegate("[class~='jvectormap-element']","mouseup",function(){var f=jvm.$(this).attr("class").baseVal?jvm.$(this).attr("class").baseVal:jvm.$(this).attr("class"),h=f.indexOf("jvectormap-region")===-1?"marker":"region",i=h=="region"?jvm.$(this).attr("data-code"):jvm.$(this).attr("data-index"),e=jvm.$.Event(h+"Click.jvectormap"),g=h=="region"?d.regions[i].element:d.markers[i].element;if(!c){d.container.trigger(e,[i]);if((h==="region"&&d.params.regionsSelectable)||(h==="marker"&&d.params.markersSelectable)){if(!e.isDefaultPrevented()){if(d.params[h+"sSelectableOne"]){d.clearSelected(h+"s")}g.setSelected(!g.isSelected)}}}})},bindZoomButtons:function(){var a=this;jvm.$("<div/>").addClass("jvectormap-zoomin").text("+").appendTo(this.container);jvm.$("<div/>").addClass("jvectormap-zoomout").html("&#x2212;").appendTo(this.container);this.container.find(".jvectormap-zoomin").click(function(){a.setScale(a.scale*a.params.zoomStep,a.width/2,a.height/2,false,a.params.zoomAnimate)});this.container.find(".jvectormap-zoomout").click(function(){a.setScale(a.scale/a.params.zoomStep,a.width/2,a.height/2,false,a.params.zoomAnimate)})},createTip:function(){var a=this;this.tip=jvm.$("<div/>").addClass("jvectormap-tip").appendTo(jvm.$("body"));this.container.mousemove(function(d){var c=d.pageX-15-a.tipWidth,b=d.pageY-15-a.tipHeight;if(c<5){c=d.pageX+15}if(b<5){b=d.pageY+15}a.tip.css({left:c,top:b})})},setScale:function(s,c,a,m,f){var n=jvm.$.Event("zoom.jvectormap"),q,k=this,o=0,h=Math.abs(Math.round((s-this.scale)*60/Math.max(s,this.scale))),l,p,e,g,j,r,d,b,t=new jvm.$.Deferred();if(s>this.params.zoomMax*this.baseScale){s=this.params.zoomMax*this.baseScale}else{if(s<this.params.zoomMin*this.baseScale){s=this.params.zoomMin*this.baseScale}}if(typeof c!="undefined"&&typeof a!="undefined"){zoomStep=s/this.scale;if(m){d=c+this.defaultWidth*(this.width/(this.defaultWidth*s))/2;b=a+this.defaultHeight*(this.height/(this.defaultHeight*s))/2}else{d=this.transX-(zoomStep-1)/s*c;b=this.transY-(zoomStep-1)/s*a}}if(f&&h>0){l=this.scale;p=(s-l)/h;e=this.transX*this.scale;j=this.transY*this.scale;g=(d*s-e)/h;r=(b*s-j)/h;q=setInterval(function(){o+=1;k.scale=l+p*o;k.transX=(e+g*o)/k.scale;k.transY=(j+r*o)/k.scale;k.applyTransform();if(o==h){clearInterval(q);k.container.trigger(n,[s/k.baseScale]);t.resolve()}},10)}else{this.transX=d;this.transY=b;this.scale=s;this.applyTransform();this.container.trigger(n,[s/this.baseScale]);t.resolve()}return t},setFocus:function(d){var g,c,f,b,e,a;d=d||{};if(d.region){b=[d.region]}else{if(d.regions){b=d.regions}}if(b){for(e=0;e<b.length;e++){if(this.regions[b[e]]){c=this.regions[b[e]].element.shape.getBBox();if(c){if(typeof g=="undefined"){g=c}else{f={x:Math.min(g.x,c.x),y:Math.min(g.y,c.y),width:Math.max(g.x+g.width,c.x+c.width)-Math.min(g.x,c.x),height:Math.max(g.y+g.height,c.y+c.height)-Math.min(g.y,c.y)};g=f}}}}return this.setScale(Math.min(this.width/g.width,this.height/g.height),-(g.x+g.width/2),-(g.y+g.height/2),true,d.animate)}else{if(d.lat&&d.lng){a=this.latLngToPoint(d.lat,d.lng);d.x=this.transX-a.x/this.scale;d.y=this.transY-a.y/this.scale}else{if(d.x&&d.y){d.x*=-this.defaultWidth;d.y*=-this.defaultHeight}}return this.setScale(d.scale*this.baseScale,d.x,d.y,true,d.animate)}},getSelected:function(c){var a,b=[];for(a in this[c]){if(this[c][a].element.isSelected){b.push(a)}}return b},getSelectedRegions:function(){return this.getSelected("regions")},getSelectedMarkers:function(){return this.getSelected("markers")},setSelected:function(b,c){var a;if(typeof c!="object"){c=[c]}if(jvm.$.isArray(c)){for(a=0;a<c.length;a++){this[b][c[a]].element.setSelected(true)}}else{for(a in c){this[b][a].element.setSelected(!!c[a])}}},setSelectedRegions:function(a){this.setSelected("regions",a)},setSelectedMarkers:function(a){this.setSelected("markers",a)},clearSelected:function(d){var a={},c=this.getSelected(d),b;for(b=0;b<c.length;b++){a[c[b]]=false}this.setSelected(d,a)},clearSelectedRegions:function(){this.clearSelected("regions")},clearSelectedMarkers:function(){this.clearSelected("markers")},getMapObject:function(){return this},getRegionName:function(a){return this.mapData.paths[a].name},createRegions:function(){var a,c,b=this;this.regionLabelsGroup=this.regionLabelsGroup||this.canvas.addGroup();for(a in this.mapData.paths){c=new jvm.Region({map:this,path:this.mapData.paths[a].path,code:a,style:jvm.$.extend(true,{},this.params.regionStyle),labelStyle:jvm.$.extend(true,{},this.params.regionLabelStyle),canvas:this.canvas,labelsGroup:this.regionLabelsGroup,label:this.canvas.mode!="vml"?(this.params.labels&&this.params.labels.regions):null});jvm.$(c.shape).bind("selected",function(f,d){b.container.trigger("regionSelected.jvectormap",[jvm.$(this.node).attr("data-code"),d,b.getSelectedRegions()])});this.regions[a]={element:c,config:this.mapData.paths[a]}}},createMarkers:function(g){var d,c,b,f,a,e=this;this.markersGroup=this.markersGroup||this.canvas.addGroup();this.markerLabelsGroup=this.markerLabelsGroup||this.canvas.addGroup();if(jvm.$.isArray(g)){a=g.slice();g={};for(d=0;d<a.length;d++){g[d]=a[d]}}for(d in g){f=g[d] instanceof Array?{latLng:g[d]}:g[d];b=this.getMarkerPosition(f);if(b!==false){c=new jvm.Marker({map:this,style:jvm.$.extend(true,{},this.params.markerStyle,{initial:f.style||{}}),labelStyle:jvm.$.extend(true,{},this.params.markerLabelStyle),index:d,cx:b.x,cy:b.y,group:this.markersGroup,canvas:this.canvas,labelsGroup:this.markerLabelsGroup,label:this.canvas.mode!="vml"?(this.params.labels&&this.params.labels.markers):null});jvm.$(c.shape).bind("selected",function(i,h){e.container.trigger("markerSelected.jvectormap",[jvm.$(this.node).attr("data-index"),h,e.getSelectedMarkers()])});if(this.markers[d]){this.removeMarkers([d])}this.markers[d]={element:c,config:f}}}},repositionMarkers:function(){var b,a;for(b in this.markers){a=this.getMarkerPosition(this.markers[b].config);if(a!==false){this.markers[b].element.setStyle({cx:a.x,cy:a.y})}}},repositionLabels:function(){var a;for(a in this.regions){this.regions[a].element.updateLabelPosition()}for(a in this.markers){this.markers[a].element.updateLabelPosition()}},getMarkerPosition:function(a){if(jvm.Map.maps[this.params.map].projection){return this.latLngToPoint.apply(this,a.latLng||[0,0])}else{return{x:a.coords[0]*this.scale+this.transX*this.scale,y:a.coords[1]*this.scale+this.transY*this.scale}}},addMarker:function(e,a,d){var g={},f=[],b,c,d=d||[];g[e]=a;for(c=0;c<d.length;c++){b={};if(typeof d[c]!=="undefined"){b[e]=d[c]}f.push(b)}this.addMarkers(g,f)},addMarkers:function(c,b){var a;b=b||[];this.createMarkers(c);for(a=0;a<b.length;a++){this.series.markers[a].setValues(b[a]||{})}},removeMarkers:function(b){var a;for(a=0;a<b.length;a++){this.markers[b[a]].element.remove();delete this.markers[b[a]]}},removeAllMarkers:function(){var a,b=[];for(a in this.markers){b.push(a)}this.removeMarkers(b)},latLngToPoint:function(f,c){var a,d=jvm.Map.maps[this.params.map].projection,e=d.centralMeridian,b,g;if(c<(-180+e)){c+=360}a=jvm.Proj[d.type](f,c,e);b=this.getInsetForPoint(a.x,a.y);if(b){g=b.bbox;a.x=(a.x-g[0].x)/(g[1].x-g[0].x)*b.width*this.scale;a.y=(a.y-g[0].y)/(g[1].y-g[0].y)*b.height*this.scale;return{x:a.x+this.transX*this.scale+b.left*this.scale,y:a.y+this.transY*this.scale+b.top*this.scale}}else{return false}},pointToLatLng:function(h,g){var b=jvm.Map.maps[this.params.map].projection,c=b.centralMeridian,a=jvm.Map.maps[this.params.map].insets,d,k,j,f,e;for(d=0;d<a.length;d++){k=a[d];j=k.bbox;f=h-(this.transX*this.scale+k.left*this.scale);e=g-(this.transY*this.scale+k.top*this.scale);f=(f/(k.width*this.scale))*(j[1].x-j[0].x)+j[0].x;e=(e/(k.height*this.scale))*(j[1].y-j[0].y)+j[0].y;if(f>j[0].x&&f<j[1].x&&e>j[0].y&&e<j[1].y){return jvm.Proj[b.type+"_inv"](f,-e,c)}}return false},getInsetForPoint:function(a,e){var b=jvm.Map.maps[this.params.map].insets,c,d;for(c=0;c<b.length;c++){d=b[c].bbox;if(a>d[0].x&&a<d[1].x&&e>d[0].y&&e<d[1].y){return b[c]}}},createSeries:function(){var b,a;this.series={markers:[],regions:[]};for(a in this.params.series){for(b=0;b<this.params.series[a].length;b++){this.series[a][b]=new jvm.DataSeries(this.params.series[a][b],this[a],this)}}},remove:function(){this.tip.remove();this.container.remove();jvm.$(window).unbind("resize",this.onResize);jvm.$("body").unbind("mouseup",this.onContainerMouseUp)}};jvm.Map.maps={};jvm.Map.defaultParams={map:"world_mill_en",backgroundColor:"#505050",zoomButtons:true,zoomOnScroll:true,zoomOnScrollSpeed:3,panOnDrag:true,zoomMax:8,zoomMin:1,zoomStep:1.6,zoomAnimate:true,regionsSelectable:false,markersSelectable:false,bindTouchEvents:true,regionStyle:{initial:{fill:"white","fill-opacity":1,stroke:"none","stroke-width":0,"stroke-opacity":1},hover:{"fill-opacity":0.8,cursor:"pointer"},selected:{fill:"yellow"},selectedHover:{}},regionLabelStyle:{initial:{"font-family":"Verdana","font-size":"12","font-weight":"bold",cursor:"default",fill:"black"},hover:{cursor:"pointer"}},markerStyle:{initial:{fill:"grey",stroke:"#505050","fill-opacity":1,"stroke-width":1,"stroke-opacity":1,r:5},hover:{stroke:"black","stroke-width":2,cursor:"pointer"},selected:{fill:"blue"},selectedHover:{}},markerLabelStyle:{initial:{"font-family":"Verdana","font-size":"12","font-weight":"bold",cursor:"default",fill:"black"},hover:{cursor:"pointer"}}};jvm.Map.apiEvents={onRegionTipShow:"regionTipShow",onRegionOver:"regionOver",onRegionOut:"regionOut",onRegionClick:"regionClick",onRegionSelected:"regionSelected",onMarkerTipShow:"markerTipShow",onMarkerOver:"markerOver",onMarkerOut:"markerOut",onMarkerClick:"markerClick",onMarkerSelected:"markerSelected",onViewportChange:"viewportChange"};